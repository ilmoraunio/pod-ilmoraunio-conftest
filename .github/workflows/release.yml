name: Release

on: push

jobs:
  windows-build:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v3
      - name: Read version to environment
        run: |
          $version = Get-Content -Path "resources/POD_ILMORAUNIO_CONFTEST_PARSER"
          echo "VERSION=$version" >> $env:GITHUB_ENV
      - name: Download bb
        run: powershell -Command "if (Test-Path('bb.exe')) { return } else { (New-Object Net.WebClient).DownloadFile('https://github.com/borkdude/babashka/releases/download/v1.0.169/babashka-1.0.169-windows-amd64.zip', 'bb.zip') }"
      - name: Extract bb
        run: powershell -Command "if (Test-Path('bb.exe')) { return } else { Expand-Archive bb.zip . }"
      - name: Download go
        run: (New-Object Net.WebClient).DownloadFile('https://go.dev/dl/go1.23.2.windows-amd64.msi', 'go1.23.2.windows-amd64.msi')
      - name: Install go
        run: Start-Process msiexec.exe -Wait -ArgumentList '/i go1.23.2.windows-amd64.msi /qn /norestart'
      - name: Install deps
        run: go install
      - name: Build binary
        run: go build
      - name: Debug
        run: Get-ChildItem
      - name: Produce artifact
        run: Compress-Archive -Path "pod-ilmoraunio-conftest.exe" -DestinationPath pod-ilmoraunio-conftest-parser-$env:VERSION-windows-amd64.zip
      - name: Release artifact
        run: .\bb.exe release-artifact --file pod-ilmoraunio-conftest-parser-$env:VERSION-windows-amd64.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  macos-build:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v3
      - name: Read version to environment
        run: echo "VERSION=$(cat resources/POD_ILMORAUNIO_CONFTEST_PARSER)" >> $GITHUB_ENV
      - name: Install babashka
        uses: DeLaGuardo/setup-clojure@13.0
        with:
          bb: 1.12.195
      - name: Install Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.22.6'
      - name: Debug
        run: go version
      - name: Install deps
        run: go install
      - name: Build binary
        run: go build
      - name: Debug
        run: ls -lart
      - name: Produce artifact
        run: zip pod-ilmoraunio-conftest-parser-$VERSION-macos-aarch64.zip pod-ilmoraunio-conftest
      - name: Release artifact
        run: bb release-artifact --file pod-ilmoraunio-conftest-parser-$VERSION-macos-aarch64.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
