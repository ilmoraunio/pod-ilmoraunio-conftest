name: Release

on: push

jobs:
  build:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v2
      - name: Download bb
        run: powershell -Command "if (Test-Path('bb.exe')) { return } else { (New-Object Net.WebClient).DownloadFile('https://github.com/borkdude/babashka/releases/download/v1.0.169/babashka-1.0.169-windows-amd64.zip', 'bb.zip') }"
      - name: Extract bb
        run: powershell -Command "if (Test-Path('bb.exe')) { return } else { Expand-Archive bb.zip . }"
      - name: Download go
        run: (New-Object Net.WebClient).DownloadFile('https://go.dev/dl/go1.23.2.windows-amd64.msi', 'go1.23.2.windows-amd64.msi')
      - name: Install go
        run: Start-Process msiexec.exe -Wait -ArgumentList '/i go1.23.2.windows-amd64.msi /qn /norestart'
      - name: Install deps
        run: go install
      - name: Build binary
        run: go build
      - name: Debug
        run: Get-ChildItem
      - name: Produce artifact
        run: Compress-Archive -Path "pod-ilmoraunio-conftest.exe" -DestinationPath "pod-ilmoraunio-conftest-parser-%VERSION%-windows-amd64.zip"
      - name: Release artifact
        run: .\bb.exe release-artifact --file pod-ilmoraunio-conftest-parser-%VERSION%-windows-amd64.zip
